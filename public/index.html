<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äî Ramadan Digital Skills League 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;900&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #0a1f0f;
  --surface:  #0f2a18;
  --panel:    #143421;
  --card:     #1a3f2a;
  --border:   #2d5a3f;
  --border2:  #3a6b4f;
  --gold:     #d4a843;
  --gold-l:   #f0c96a;
  --gold-d:   #8b6914;
  --teal:     #14b8a6;
  --blue:     #0d9488;
  --pink:     #10b981;
  --orange:   #059669;
  --cyan:     #14b8a6;
  --red:      #ef4444;
  --green:    #22c55e;
  --text:     #e8f5e9;
  --muted:    #81c995;
  --muted2:   #5a9d6f;
  --ace-c:    #14b8a6;
  --arena-c:  #10b981;
}
* { margin:0; padding:0; box-sizing:border-box; }
html,body { height:100%; }
body {
  font-family: 'Nunito', sans-serif;
  font-weight: 400;
  background: var(--bg);
  color: var(--text);
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  width: 240px;
  flex-shrink: 0;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}
.sidebar-logo {
  padding: 24px 20px 20px;
  border-bottom: 1px solid var(--border);
}
.logo-moon { font-size: 28px; display:block; margin-bottom:8px; }
.logo-title {
  font-family: 'Cinzel', serif;
  font-size: 13px;
  font-weight: 700;
  color: var(--gold);
  line-height: 1.3;
}
.logo-sub {
  font-size: 10px;
  color: var(--muted);
  letter-spacing: 1px;
  margin-top: 4px;
}
.sidebar-nav { padding: 16px 0; flex: 1; }
.nav-section {
  font-size: 9px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--muted2);
  padding: 12px 20px 6px;
  font-weight: 700;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  cursor: pointer;
  border-left: 2px solid transparent;
  font-size: 14px;
  font-weight: 600;
  color: var(--muted);
  transition: all 0.15s;
  text-decoration: none;
}
.nav-item:hover { color: var(--text); background: rgba(255,255,255,0.03); }
.nav-item.active {
  color: var(--gold-l);
  background: rgba(212,168,67,0.07);
  border-left-color: var(--gold);
}
.nav-icon { font-size: 16px; width: 20px; text-align: center; }
.nav-badge {
  margin-left: auto;
  background: rgba(212,168,67,0.2);
  color: var(--gold-l);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 100px;
}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar {
  padding: 16px 28px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--surface);
  flex-shrink: 0;
}
.page-title {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}
.page-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
.topbar-actions { display: flex; gap: 10px; align-items: center; }
.status-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green);
  animation: pulse2 2s ease-in-out infinite;
}
@keyframes pulse2 {
  0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.5)}
  50%{box-shadow:0 0 0 5px rgba(34,197,94,0)}
}
.conn-label { font-size: 11px; color: var(--muted); }

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content {
  flex: 1;
  overflow-y: auto;
  padding: 28px;
}

/* ‚îÄ‚îÄ PAGE SECTIONS ‚îÄ‚îÄ */
.page { display: none; }
.page.active { display: block; }

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 20px; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.card-title {
  font-family: 'Cinzel', serif;
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}
.card-body { padding: 20px; }

/* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
.form-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
.form-group { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 140px; }
label {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
}
input, select {
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 10px 13px;
  font-family: 'Nunito', sans-serif;
  font-size: 14px;
  color: var(--text);
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}
input:focus, select:focus { border-color: var(--gold-d); }
select option { background: var(--panel); }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  font-family: 'Nunito', sans-serif;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.5px;
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 7px;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn:active { transform: scale(0.97); }
.btn-primary {
  background: linear-gradient(135deg, #a07520, var(--gold));
  color: #fff;
}
.btn-primary:hover { background: linear-gradient(135deg, #b8882a, var(--gold-l)); }
.btn-ghost {
  background: transparent;
  border: 1px solid var(--border2);
  color: var(--muted);
}
.btn-ghost:hover { border-color: var(--border); color: var(--text); }
.btn-danger {
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.3);
  color: #fca5a5;
  padding: 6px 12px;
  font-size: 12px;
}
.btn-danger:hover { background: rgba(239,68,68,0.2); }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-success {
  background: rgba(34,197,94,0.1);
  border: 1px solid rgba(34,197,94,0.3);
  color: #86efac;
}
.btn-success:hover { background: rgba(34,197,94,0.2); }

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th {
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  font-weight: 700;
  padding: 10px 14px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
td {
  padding: 12px 14px;
  font-size: 14px;
  border-bottom: 1px solid rgba(37,47,74,0.5);
  vertical-align: middle;
}
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(212,168,67,0.05); }

/* ‚îÄ‚îÄ DEPT BADGE ‚îÄ‚îÄ */
.dept-badge {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 3px 9px;
  border-radius: 100px;
}
.dept-ACE {
  background: rgba(59,130,246,0.12);
  border: 1px solid rgba(59,130,246,0.3);
  color: #93c5fd;
}
.dept-ARENA {
  background: rgba(236,72,153,0.12);
  border: 1px solid rgba(236,72,153,0.3);
  color: #f9a8d4;
}

/* ‚îÄ‚îÄ CAT BADGE ‚îÄ‚îÄ */
.cat-badge {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1px;
  padding: 3px 9px;
  border-radius: 100px;
  white-space: nowrap;
}
.cat-ace1   { background:rgba(59,130,246,.12);  border:1px solid rgba(59,130,246,.3);  color:#93c5fd; }
.cat-ace2   { background:rgba(6,182,212,.12);   border:1px solid rgba(6,182,212,.3);   color:#67e8f9; }
.cat-arena1 { background:rgba(236,72,153,.12);  border:1px solid rgba(236,72,153,.3);  color:#f9a8d4; }
.cat-arena2 { background:rgba(249,115,22,.12);  border:1px solid rgba(249,115,22,.3);  color:#fdba74; }

/* ‚îÄ‚îÄ POINTS BADGE ‚îÄ‚îÄ */
.pts-badge {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--gold-l);
}

/* ‚îÄ‚îÄ PLACEMENT BADGE ‚îÄ‚îÄ */
.placement-badge {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.5px;
  padding: 3px 10px;
  border-radius: 100px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.placement-1st {
  background: rgba(240,201,106,0.15);
  border: 1px solid rgba(240,201,106,0.4);
  color: #f0c96a;
}
.placement-2nd {
  background: rgba(147,197,253,0.12);
  border: 1px solid rgba(147,197,253,0.3);
  color: #93c5fd;
}
.placement-3rd {
  background: rgba(200,168,122,0.15);
  border: 1px solid rgba(200,168,122,0.4);
  color: #c8a87a;
}
.placement-participant {
  background: rgba(129,201,149,0.1);
  border: 1px solid rgba(129,201,149,0.25);
  color: #81c995;
}

/* ‚îÄ‚îÄ AVATAR ‚îÄ‚îÄ */
.avatar {
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px;
  font-family: 'Cinzel', serif;
  font-weight: 700;
  color: #fff;
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ SCORE INPUT ROW ‚îÄ‚îÄ */
.score-inline-input {
  width: 70px;
  padding: 5px 8px;
  text-align: center;
  font-size: 14px;
}

/* ‚îÄ‚îÄ STAT MINI CARDS ‚îÄ‚îÄ */
.stat-mini {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px 20px;
  display: flex;
  align-items: center;
  gap: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.stat-mini-icon { font-size: 28px; }
.stat-mini-val {
  font-family: 'Cinzel', serif;
  font-size: 28px;
  font-weight: 900;
  color: var(--gold-l);
  line-height: 1;
}
.stat-mini-label { font-size: 11px; color: var(--muted); margin-top: 3px; }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty {
  text-align: center;
  padding: 40px 20px;
  color: var(--muted);
  font-size: 14px;
}
.empty-icon { font-size: 36px; margin-bottom: 12px; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  z-index: 999;
  display: none;
  animation: slideIn 0.3s ease;
  max-width: 320px;
}
#toast.success { background:#0f4a1f; border:1px solid #22c55e; color:#86efac; }
#toast.error   { background:#4a0f0f; border:1px solid #ef4444; color:#fca5a5; }
@keyframes slideIn {
  from { opacity:0; transform:translateY(10px); }
  to   { opacity:1; transform:translateY(0); }
}

/* ‚îÄ‚îÄ LEADERBOARD RANK ‚îÄ‚îÄ */
.rank-num {
  font-family: 'Cinzel', serif;
  font-size: 13px;
  font-weight: 700;
}
.rank-1 { color: var(--gold-l); }
.rank-2 { color: #93c5fd; }
.rank-3 { color: #c8a87a; }
.rank-n { color: var(--muted); }

.score-bar-wrap {
  width: 100%; height: 4px;
  background: rgba(255,255,255,0.05);
  border-radius: 2px; overflow: hidden; margin-top: 4px;
}
.score-bar { height: 100%; border-radius: 2px; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.4);
  display: flex; align-items: center; justify-content: center;
  z-index: 100;
  display: none;
  backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--card);
  border: 1px solid var(--border2);
  border-radius: 16px;
  box-shadow: 0 12px 48px rgba(0,0,0,0.2);
  padding: 28px;
  width: 100%;
  max-width: 440px;
  animation: fadeUp 0.2s ease;
}
@keyframes fadeUp {
  from { opacity:0; transform:translateY(12px); }
  to   { opacity:1; transform:translateY(0); }
}
.modal-title {
  font-family: 'Cinzel', serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--text);
}
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

/* ‚îÄ‚îÄ ENROLLMENT CHIPS ‚îÄ‚îÄ */
.enrollment-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 4px;
}
.enrollment-chip {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.5px;
  padding: 2px 8px;
  border-radius: 100px;
  white-space: nowrap;
}

/* ‚îÄ‚îÄ COMPETITION CHECKLIST (inside modal) ‚îÄ‚îÄ */
.comp-checklist {
  max-height: 260px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 8px;
}
.comp-check-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 8px;
  background: var(--panel);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.15s;
}
.comp-check-item:hover { border-color: var(--border2); }
.comp-check-item.checked {
  border-color: var(--gold-d);
  background: rgba(212,168,67,0.08);
}
.comp-check-item input[type="checkbox"] {
  width: 16px; height: 16px;
  accent-color: var(--gold);
  cursor: pointer;
}
.comp-check-name { font-size: 13px; font-weight: 600; }
.comp-check-cat { font-size: 10px; color: var(--muted); }

/* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
.filter-bar {
  display: flex;
  gap: 8px;
  align-items: center;
}
.filter-bar select {
  padding: 6px 10px;
  font-size: 12px;
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: 6px;
  color: var(--text);
  width: auto;
  min-width: 100px;
}

/* ‚îÄ‚îÄ GRADING INFO ‚îÄ‚îÄ */
.grading-legend {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  padding: 10px 0;
  font-size: 12px;
  color: var(--muted);
}
.grading-legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

.divider { height: 1px; background: var(--border); margin: 24px 0; }
.section-head {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.section-head::after { content:''; flex:1; height:1px; background:var(--border); }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 768px) {
  body { flex-direction: column; }
  
  .sidebar {
    width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid var(--border);
    flex-direction: row;
    overflow-x: auto;
    overflow-y: hidden;
  }
  
  .sidebar-logo { display: none; }
  
  .sidebar-nav {
    display: flex;
    flex-direction: row;
    gap: 0;
    padding: 0;
    width: 100%;
  }
  
  .nav-section { display: none; }
  
  .nav-item {
    flex-direction: column;
    padding: 12px 16px;
    border-left: none;
    border-bottom: 2px solid transparent;
    min-width: auto;
    white-space: nowrap;
    gap: 4px;
  }
  
  .nav-item.active {
    border-left: none;
    border-bottom-color: var(--gold);
  }
  
  .nav-item span:not(.nav-icon) {
    font-size: 10px;
    letter-spacing: 0.5px;
  }
  
  .nav-icon { font-size: 18px; }
  .nav-badge { display: none; }
  
  .main { height: auto; }
  
  .topbar {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  
  .topbar-actions {
    width: 100%;
  }
  
  .content { padding: 20px 16px; }
  
  .grid-2, .grid-3 { grid-template-columns: 1fr; }
  
  .form-row { flex-direction: column; }
  .form-group { width: 100% !important; flex: 1 !important; }
  
  .table-wrap { overflow-x: auto; }
  table { min-width: 600px; }
}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <span class="logo-moon">üåô</span>
    <div class="logo-title">Ramadan Digital<br>Skills League</div>
    <div class="logo-sub">ADMIN DASHBOARD</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section">Overview</div>
    <a class="nav-item active" onclick="showPage('dashboard',this)">
      <span class="nav-icon">üìä</span><span>Dashboard</span>
    </a>

    <div class="nav-section">Management</div>
    <a class="nav-item" onclick="showPage('students',this)">
      <span class="nav-icon">üë•</span><span>Students</span>
      <span class="nav-badge" id="badge-students">0</span>
    </a>
    <a class="nav-item" onclick="showPage('competitions',this)">
      <span class="nav-icon">üèÜ</span><span>Competitions</span>
      <span class="nav-badge" id="badge-comps">0</span>
    </a>
    <a class="nav-item" onclick="showPage('scores',this)">
      <span class="nav-icon">‚ö°</span><span>Grading</span>
    </a>

    <div class="nav-section">Results</div>
    <a class="nav-item" onclick="showPage('leaderboard',this)">
      <span class="nav-icon">üéñÔ∏è</span><span>Leaderboard</span>
    </a>

    <div class="nav-section">Public</div>
    <a class="nav-item" href="/leaderboard.html" target="_blank">
      <span class="nav-icon">üåô</span><span>Live Display</span>
      <span style="margin-left:auto;font-size:10px;color:var(--muted2)">‚Üó</span>
    </a>
  </nav>
</aside>

<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
<div class="main">
  <div class="topbar">
    <div>
      <div class="page-title" id="topbar-title">Dashboard</div>
      <div class="page-sub" id="topbar-sub">Overview of the Ramadan Digital Skills League</div>
    </div>
    <div class="topbar-actions">
      <div class="topbar-actions">
        <button class="btn btn-ghost btn-sm" onclick="logout()" style="padding:6px 12px">üö™ Logout</button>
        <div class="status-dot" id="conn-dot" style="background:var(--muted2)"></div>
        <div class="conn-label" id="conn-label">Connecting‚Ä¶</div>
      </div>
    </div>
  </div>

  <div class="content">

    <!-- ‚îÄ‚îÄ PAGE: DASHBOARD ‚îÄ‚îÄ -->
    <div id="page-dashboard" class="page active">
      <div class="grid-3" id="stat-cards" style="margin-bottom:24px">
        <div class="stat-mini"><div class="stat-mini-icon">üë•</div><div><div class="stat-mini-val" id="s-students">‚Äî</div><div class="stat-mini-label">Students</div></div></div>
        <div class="stat-mini"><div class="stat-mini-icon">üèÜ</div><div><div class="stat-mini-val" id="s-comps">‚Äî</div><div class="stat-mini-label">Competitions</div></div></div>
        <div class="stat-mini"><div class="stat-mini-icon">üìù</div><div><div class="stat-mini-val" id="s-scores">‚Äî</div><div class="stat-mini-label">Scores Recorded</div></div></div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ü•á Overall Top 5</div>
          </div>
          <div class="card-body" id="dash-overall"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">‚ö° Recent Scores</div>
            <button class="btn btn-ghost btn-sm" onclick="showPage('scores', document.querySelector('[onclick*=scores]'))">+ Add Score</button>
          </div>
          <div class="card-body" id="dash-recent"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid-2">
        <div class="card">
          <div class="card-header"><div class="card-title">üñ•Ô∏è Ramadan Code Quest ‚Äî Top 3</div></div>
          <div class="card-body" id="dash-ace1"></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">‚ö° Fast-Tech Firdaus ‚Äî Top 3</div></div>
          <div class="card-body" id="dash-ace2"></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üé® Crescent Creative Studio ‚Äî Top 3</div></div>
          <div class="card-body" id="dash-arena1"></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üåü Digital Suhoor Designers ‚Äî Top 3</div></div>
          <div class="card-body" id="dash-arena2"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PAGE: STUDENTS ‚îÄ‚îÄ -->
    <div id="page-students" class="page">
      <div class="card" style="margin-bottom:20px">
        <div class="card-header"><div class="card-title">‚ûï Add Student</div></div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label>Full Name</label>
              <input id="st-name" type="text" placeholder="e.g. Sara Al-Rashid">
            </div>
            <div class="form-group">
              <label>Programme</label>
              <select id="st-dept">
                <option value="ACE">ACE ‚Äî Aptech Computer</option>
                <option value="ARENA">ARENA ‚Äî Multimedia</option>
              </select>
            </div>
            <div class="form-group" style="flex:0">
              <label>&nbsp;</label>
              <button class="btn btn-primary" onclick="addStudent()">‚ú¶ Add Student</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üë• All Students</div>
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:12px;color:var(--muted)" id="students-count"></span>
            <div class="filter-bar">
              <select id="students-filter-dept" onchange="renderStudents()">
                <option value="">All Programmes</option>
                <option value="ACE">ACE</option>
                <option value="ARENA">ARENA</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card-body" style="padding:0">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Programme</th>
                  <th>Enrolled Competitions</th>
                  <th>Registered</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="students-tbody">
                <tr><td colspan="5"><div class="empty"><div class="empty-icon">üë•</div>No students yet</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PAGE: COMPETITIONS ‚îÄ‚îÄ -->
    <div id="page-competitions" class="page">
      <div class="card" style="margin-bottom:20px">
        <div class="card-header"><div class="card-title">‚ûï Add Competition</div></div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label>Competition Name</label>
              <input id="cp-name" type="text" placeholder="e.g. Coding Speed Test">
            </div>
            <div class="form-group">
              <label>Category</label>
              <select id="cp-cat">
                <option value="ace1">üñ•Ô∏è Ramadan Code Quest (ACE Wk1‚Äì2)</option>
                <option value="ace2">‚ö° Fast-Tech Firdaus (ACE Wk3‚Äì4)</option>
                <option value="arena1">üé® Crescent Creative Studio (ARENA Wk1‚Äì2)</option>
                <option value="arena2">üåü Digital Suhoor Designers (ARENA Wk3‚Äì4)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Date</label>
              <input id="cp-date" type="date">
            </div>
            <div class="form-group" style="flex:0">
              <label>&nbsp;</label>
              <button class="btn btn-primary" onclick="addCompetition()">‚ú¶ Add</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üèÜ All Competitions</div>
          <span style="font-size:12px;color:var(--muted)" id="comps-count"></span>
        </div>
        <div class="card-body" style="padding:0">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Competition</th>
                  <th>Category</th>
                  <th>Date</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="comps-tbody">
                <tr><td colspan="4"><div class="empty"><div class="empty-icon">üèÜ</div>No competitions yet</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PAGE: SCORES (GRADING) ‚îÄ‚îÄ -->
    <div id="page-scores" class="page">
      <div class="card" style="margin-bottom:20px">
        <div class="card-header">
          <div class="card-title">‚ö° Grade Competition</div>
        </div>
        <div class="card-body">
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group" style="flex:2">
              <label>Competition</label>
              <select id="sc-comp" onchange="onGradeCompChange()"></select>
            </div>
          </div>

          <!-- Grading legend -->
          <div class="grading-legend" style="margin-bottom:16px">
            <div class="grading-legend-item"><span class="placement-badge placement-1st">ü•á 1st</span> <span>= 25 pts</span></div>
            <div class="grading-legend-item"><span class="placement-badge placement-2nd">ü•à 2nd</span> <span>= 20 pts</span></div>
            <div class="grading-legend-item"><span class="placement-badge placement-3rd">ü•â 3rd</span> <span>= 15 pts</span></div>
            <div class="grading-legend-item"><span class="placement-badge placement-participant">‚ú¶ Participant</span> <span>= 10 pts</span></div>
          </div>

          <!-- Enrolled students for selected competition -->
          <div id="grading-panel">
            <div class="empty" style="padding:20px 0"><div class="empty-icon" style="font-size:24px">üèÜ</div>Select a competition above to grade enrolled students</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üìù All Scores</div>
          <div style="display:flex;gap:8px">
            <select id="scores-filter-comp" onchange="renderScores()" style="padding:6px 10px;font-size:12px;background:var(--panel);border:1px solid var(--border2);border-radius:6px;color:var(--text)">
              <option value="">All Competitions</option>
            </select>
            <select id="scores-filter-dept" onchange="renderScores()" style="padding:6px 10px;font-size:12px;background:var(--panel);border:1px solid var(--border2);border-radius:6px;color:var(--text)">
              <option value="">All Depts</option>
              <option value="ACE">ACE</option>
              <option value="ARENA">ARENA</option>
            </select>
          </div>
        </div>
        <div class="card-body" style="padding:0">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Competition</th>
                  <th>Category</th>
                  <th>Placement</th>
                  <th>Points</th>
                  <th>Updated</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="scores-tbody">
                <tr><td colspan="7"><div class="empty"><div class="empty-icon">üìù</div>No scores yet</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PAGE: LEADERBOARD ‚îÄ‚îÄ -->
    <div id="page-leaderboard" class="page">

      <!-- Overall -->
      <div class="section-head">üèÜ Overall Standings ‚Äî Grand Champion Race</div>
      <div class="card" style="margin-bottom:24px">
        <div class="card-body" style="padding:0">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>#</th><th>Student</th><th>Programme</th><th>Code Quest</th><th>Fast-Tech</th><th>Creative</th><th>Suhoor</th><th>Total</th></tr>
              </thead>
              <tbody id="lb-overall"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Per category -->
      <div class="grid-2">
        <div class="card">
          <div class="card-header"><div class="card-title">üñ•Ô∏è Ramadan Code Quest</div><span class="cat-badge cat-ace1">ACE Wk1‚Äì2</span></div>
          <div class="card-body" style="padding:0"><div class="table-wrap"><table><thead><tr><th>#</th><th>Student</th><th>Points</th></tr></thead><tbody id="lb-ace1"></tbody></table></div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">‚ö° Fast-Tech Firdaus</div><span class="cat-badge cat-ace2">ACE Wk3‚Äì4</span></div>
          <div class="card-body" style="padding:0"><div class="table-wrap"><table><thead><tr><th>#</th><th>Student</th><th>Points</th></tr></thead><tbody id="lb-ace2"></tbody></table></div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üé® Crescent Creative Studio</div><span class="cat-badge cat-arena1">ARENA Wk1‚Äì2</span></div>
          <div class="card-body" style="padding:0"><div class="table-wrap"><table><thead><tr><th>#</th><th>Student</th><th>Points</th></tr></thead><tbody id="lb-arena1"></tbody></table></div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üåü Digital Suhoor Designers</div><span class="cat-badge cat-arena2">ARENA Wk3‚Äì4</span></div>
          <div class="card-body" style="padding:0"><div class="table-wrap"><table><thead><tr><th>#</th><th>Student</th><th>Points</th></tr></thead><tbody id="lb-arena2"></tbody></table></div></div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ -->
<div id="toast"></div>

<!-- ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="confirm-modal">
  <div class="modal">
    <div class="modal-title">‚ö†Ô∏è Confirm Delete</div>
    <div id="confirm-msg" style="color:var(--muted);font-size:14px;line-height:1.6"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeConfirm()">Cancel</button>
      <button class="btn btn-danger" id="confirm-ok">Delete</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ ENROLL MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="enroll-modal">
  <div class="modal">
    <div class="modal-title" id="enroll-modal-title">üìã Manage Enrollments</div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:14px">Select which competitions this student is participating in:</div>
    <div class="comp-checklist" id="enroll-checklist"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeEnroll()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEnrollments()">‚ú¶ Save Enrollments</button>
    </div>
  </div>
</div>

<script>
  fetch('/auth/check', {
    credentials: 'include'
  })
  .then(r => r.json())
  .then(data => {
    if (!data.authenticated) {
      window.location.href = '/';
    }
  })
  .catch(() => window.location.href = '/');

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let state = { students: [], competitions: [], scores: [] };
let confirmCb = null;
let enrollStudentId = null;

// ‚îÄ‚îÄ PLACEMENT ‚Üí POINTS MAPPING ‚îÄ‚îÄ
const PLACEMENT_PTS = { '1st': 25, '2nd': 20, '3rd': 15, 'participant': 10 };
const PTS_PLACEMENT = { 25: '1st', 20: '2nd', 15: '3rd', 10: 'participant' };

function placementLabel(pts) {
  if (pts === 25) return '<span class="placement-badge placement-1st">ü•á 1st Place</span>';
  if (pts === 20) return '<span class="placement-badge placement-2nd">ü•à 2nd Place</span>';
  if (pts === 15) return '<span class="placement-badge placement-3rd">ü•â 3rd Place</span>';
  return '<span class="placement-badge placement-participant">‚ú¶ Participant</span>';
}

// ‚îÄ‚îÄ API BASE ‚îÄ‚îÄ
const API = '/api';

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function toast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = type;
  t.style.display = 'block';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.style.display = 'none', 3000);
}

// ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ
function confirmModal(msg, cb) {
  document.getElementById('confirm-msg').textContent = msg;
  document.getElementById('confirm-ok').onclick = () => { closeConfirm(); cb(); };
  document.getElementById('confirm-modal').classList.add('open');
}
function closeConfirm() {
  document.getElementById('confirm-modal').classList.remove('open');
}

// ‚îÄ‚îÄ ENROLL MODAL ‚îÄ‚îÄ
function openEnroll(studentId) {
  enrollStudentId = studentId;
  const student = state.students.find(s => s._id === studentId);
  if (!student) return;
  
  document.getElementById('enroll-modal-title').textContent = `üìã Enrollments ‚Äî ${student.name}`;
  
  const enrolled = student.enrolledCompetitions || [];
  const checklist = document.getElementById('enroll-checklist');
  
  if (!state.competitions.length) {
    checklist.innerHTML = '<div class="empty" style="padding:20px 0">No competitions created yet. Add competitions first.</div>';
  } else {
    checklist.innerHTML = state.competitions.map(c => {
      const isChecked = enrolled.includes(c._id);
      return `
        <label class="comp-check-item ${isChecked ? 'checked' : ''}" onclick="this.classList.toggle('checked')">
          <input type="checkbox" value="${c._id}" ${isChecked ? 'checked' : ''}>
          <div>
            <div class="comp-check-name">${c.name}</div>
            <div class="comp-check-cat"><span class="cat-badge cat-${c.category}" style="font-size:9px;padding:1px 6px">${CAT_LABELS[c.category] || c.category}</span></div>
          </div>
        </label>`;
    }).join('');
  }
  
  document.getElementById('enroll-modal').classList.add('open');
}
function closeEnroll() {
  document.getElementById('enroll-modal').classList.remove('open');
  enrollStudentId = null;
}
async function saveEnrollments() {
  if (!enrollStudentId) return;
  const checkboxes = document.querySelectorAll('#enroll-checklist input[type="checkbox"]');
  const compIds = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
  
  try {
    const res = await fetch(`${API}/students/${enrollStudentId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enrolledCompetitions: compIds })
    });
    if (!res.ok) throw new Error((await res.json()).error);
    const updated = await res.json();
    const idx = state.students.findIndex(s => s._id === enrollStudentId);
    if (idx >= 0) state.students[idx] = updated;
    renderStudents();
    closeEnroll();
    toast(`‚úÖ Enrollments updated!`);
  } catch(e) {
    toast(e.message, 'error');
  }
}

// ‚îÄ‚îÄ PAGE NAV ‚îÄ‚îÄ
const pageMeta = {
  dashboard:    { title:'Dashboard',    sub:'Live overview of all standings' },
  students:     { title:'Students',     sub:'Add and manage registered students' },
  competitions: { title:'Competitions', sub:'Define competitions in each category' },
  scores:       { title:'Grading',      sub:'Assign placements and record student points' },
  leaderboard:  { title:'Leaderboard',  sub:'Full standings across all categories' },
};
function showPage(id, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(el) el.classList.add('active');
  const m = pageMeta[id] || {};
  document.getElementById('topbar-title').textContent = m.title||id;
  document.getElementById('topbar-sub').textContent = m.sub||'';
  if(id==='leaderboard') loadLeaderboard();
  if(id==='dashboard')   loadDashboard();
  if(id==='scores')      { renderScoreDropdowns(); onGradeCompChange(); }
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function initials(name) {
  return name.split(' ').slice(0,2).map(w=>w[0]||'').join('').toUpperCase();
}

const COLORS = ['#3b82f6','#ec4899','#10b981','#f97316','#a855f7','#06b6d4','#eab308','#ef4444','#14b8a6','#f43f5e','#84cc16','#8b5cf6'];
function colorFor(name) {
  let h = 0;
  for(let c of name) h = (h*31 + c.charCodeAt(0)) & 0xfffffff;
  return COLORS[h % COLORS.length];
}

function avatarHtml(name, size=32) {
  const c = colorFor(name);
  return `<div class="avatar" style="background:linear-gradient(135deg,${c}99,${c});width:${size}px;height:${size}px">${initials(name)}</div>`;
}

const CAT_LABELS = {
  ace1:'Ramadan Code Quest', ace2:'Fast-Tech Firdaus',
  arena1:'Crescent Creative Studio', arena2:'Digital Suhoor Designers'
};

function fmtDate(d) {
  if(!d) return '‚Äî';
  return new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
}

// ‚îÄ‚îÄ LOAD ALL DATA ‚îÄ‚îÄ
async function loadAll() {
  try {
    const [students, competitions, scores] = await Promise.all([
      fetch(`${API}/students`).then(r=>r.json()),
      fetch(`${API}/competitions`).then(r=>r.json()),
      fetch(`${API}/scores`).then(r=>r.json()),
    ]);
    state.students = students;
    state.competitions = competitions;
    state.scores = scores;
    document.getElementById('conn-dot').style.background = 'var(--green)';
    document.getElementById('conn-label').textContent = 'Connected';
    updateBadges();
    renderStudents();
    renderCompetitions();
    renderScoreDropdowns();
    renderScoresFilterComp();
    renderScores();
    loadDashboard();
  } catch(e) {
    document.getElementById('conn-dot').style.background = '#ef4444';
    document.getElementById('conn-label').textContent = 'Offline';
    toast('Failed to connect to server', 'error');
  }
}

function updateBadges() {
  document.getElementById('badge-students').textContent = state.students.length;
  document.getElementById('badge-comps').textContent = state.competitions.length;
  document.getElementById('s-students').textContent = state.students.length;
  document.getElementById('s-comps').textContent = state.competitions.length;
  document.getElementById('s-scores').textContent = state.scores.length;
}

// ‚îÄ‚îÄ STUDENTS ‚îÄ‚îÄ
async function addStudent() {
  const name = document.getElementById('st-name').value.trim();
  const dept = document.getElementById('st-dept').value;
  if(!name) { toast('Please enter a student name','error'); return; }
  try {
    const res = await fetch(`${API}/students`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,dept})});
    if(!res.ok) throw new Error((await res.json()).error);
    const s = await res.json();
    state.students.push(s);
    state.students.sort((a,b)=>a.name.localeCompare(b.name));
    document.getElementById('st-name').value = '';
    updateBadges();
    renderStudents();
    renderScoreDropdowns();
    toast(`‚úÖ ${s.name} added!`);
  } catch(e) { toast(e.message,'error'); }
}

function renderStudents() {
  const tb = document.getElementById('students-tbody');
  const fDept = document.getElementById('students-filter-dept').value;
  
  let filtered = state.students;
  if (fDept) {
    filtered = filtered.filter(s => s.dept === fDept);
  }
  
  document.getElementById('students-count').textContent = `${filtered.length} of ${state.students.length} student${state.students.length!==1?'s':''}`;
  
  if(!filtered.length) {
    const msg = fDept ? `No ${fDept} students found` : 'No students yet ‚Äî add one above';
    tb.innerHTML = `<tr><td colspan="5"><div class="empty"><div class="empty-icon">üë•</div>${msg}</div></td></tr>`;
    return;
  }
  tb.innerHTML = filtered.map(s => {
    // Build enrollment chips
    const enrolled = s.enrolledCompetitions || [];
    let enrollChips = '';
    if (enrolled.length > 0) {
      enrollChips = enrolled.map(cId => {
        const comp = state.competitions.find(c => c._id === cId);
        if (!comp) return '';
        return `<span class="enrollment-chip cat-${comp.category}">${comp.name}</span>`;
      }).filter(Boolean).join('');
    } else {
      enrollChips = '<span style="font-size:11px;color:var(--muted2);font-style:italic">Not enrolled yet</span>';
    }
    
    return `
    <tr>
      <td><div style="display:flex;align-items:center;gap:10px">${avatarHtml(s.name)}<strong>${s.name}</strong></div></td>
      <td><span class="dept-badge dept-${s.dept}">${s.dept}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <div class="enrollment-chips">${enrollChips}</div>
          <button class="btn btn-ghost btn-sm" style="padding:3px 8px;font-size:10px" onclick="openEnroll('${s._id}')">‚úèÔ∏è Edit</button>
        </div>
      </td>
      <td style="color:var(--muted)">${fmtDate(s.createdAt)}</td>
      <td><button class="btn btn-danger" onclick="deleteStudent('${s._id}','${s.name}')">‚úï Remove</button></td>
    </tr>`;
  }).join('');
}

async function deleteStudent(id, name) {
  confirmModal(`Remove "${name}" and all their scores?`, async () => {
    await fetch(`${API}/students/${id}`,{method:'DELETE'});
    state.students = state.students.filter(s=>s._id!==id);
    state.scores   = state.scores.filter(s=>s.student?._id!==id);
    updateBadges(); renderStudents(); renderScoreDropdowns(); renderScores();
    toast(`Removed ${name}`);
  });
}

// ‚îÄ‚îÄ COMPETITIONS ‚îÄ‚îÄ
async function addCompetition() {
  const name     = document.getElementById('cp-name').value.trim();
  const category = document.getElementById('cp-cat').value;
  const date     = document.getElementById('cp-date').value;
  if(!name) { toast('Please enter a competition name','error'); return; }
  try {
    const res = await fetch(`${API}/competitions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,category,date})});
    if(!res.ok) throw new Error((await res.json()).error);
    const c = await res.json();
    state.competitions.push(c);
    document.getElementById('cp-name').value = '';
    updateBadges(); renderCompetitions(); renderScoreDropdowns(); renderScoresFilterComp();
    toast(`‚úÖ "${c.name}" added!`);
  } catch(e) { toast(e.message,'error'); }
}

function renderCompetitions() {
  const tb = document.getElementById('comps-tbody');
  document.getElementById('comps-count').textContent = `${state.competitions.length} competition${state.competitions.length!==1?'s':''}`;
  if(!state.competitions.length) {
    tb.innerHTML = `<tr><td colspan="4"><div class="empty"><div class="empty-icon">üèÜ</div>No competitions yet</div></td></tr>`;
    return;
  }
  tb.innerHTML = state.competitions.map(c => `
    <tr>
      <td><strong>${c.name}</strong></td>
      <td><span class="cat-badge cat-${c.category}">${CAT_LABELS[c.category]||c.category}</span></td>
      <td style="color:var(--muted)">${fmtDate(c.date||c.createdAt)}</td>
      <td><button class="btn btn-danger" onclick="deleteCompetition('${c._id}','${c.name}')">‚úï Remove</button></td>
    </tr>`).join('');
}

async function deleteCompetition(id, name) {
  confirmModal(`Remove "${name}" and all its scores?`, async () => {
    await fetch(`${API}/competitions/${id}`,{method:'DELETE'});
    state.competitions = state.competitions.filter(c=>c._id!==id);
    state.scores       = state.scores.filter(s=>s.competition?._id!==id);
    // Also remove from student enrollments locally
    state.students.forEach(s => {
      if (s.enrolledCompetitions) {
        s.enrolledCompetitions = s.enrolledCompetitions.filter(cId => cId !== id);
      }
    });
    updateBadges(); renderCompetitions(); renderScoreDropdowns(); renderScoresFilterComp(); renderScores();
    toast(`Removed "${name}"`);
  });
}

// ‚îÄ‚îÄ SCORE DROPDOWNS ‚îÄ‚îÄ
function renderScoreDropdowns() {
  const sc = document.getElementById('sc-comp');
  sc.innerHTML = state.competitions.length
    ? '<option value="">‚Äî Select Competition ‚Äî</option>' + state.competitions.map(c=>`<option value="${c._id}">${c.name} ‚Äî ${CAT_LABELS[c.category]||c.category}</option>`).join('')
    : '<option disabled>No competitions yet</option>';
}

function renderScoresFilterComp() {
  const sel = document.getElementById('scores-filter-comp');
  const val = sel.value;
  sel.innerHTML = '<option value="">All Competitions</option>' +
    state.competitions.map(c=>`<option value="${c._id}">${c.name}</option>`).join('');
  sel.value = val;
}

// ‚îÄ‚îÄ GRADING PANEL ‚îÄ‚îÄ
function onGradeCompChange() {
  const compId = document.getElementById('sc-comp').value;
  const panel = document.getElementById('grading-panel');
  
  if (!compId) {
    panel.innerHTML = '<div class="empty" style="padding:20px 0"><div class="empty-icon" style="font-size:24px">üèÜ</div>Select a competition above to grade enrolled students</div>';
    return;
  }
  
  const comp = state.competitions.find(c => c._id === compId);
  if (!comp) return;
  
  // Find students enrolled in this competition
  const enrolledStudents = state.students.filter(s => 
    s.enrolledCompetitions && s.enrolledCompetitions.includes(compId)
  );
  
  if (!enrolledStudents.length) {
    panel.innerHTML = `<div class="empty" style="padding:20px 0"><div class="empty-icon" style="font-size:24px">üë•</div>No students enrolled in this competition yet.<br><span style="font-size:12px">Go to Students ‚Üí Edit enrollments to add students.</span></div>`;
    return;
  }
  
  // Build grading rows
  let html = '<div style="display:flex;flex-direction:column;gap:8px">';
  enrolledStudents.forEach(s => {
    // Check if already scored
    const existing = state.scores.find(sc => sc.student?._id === s._id && sc.competition?._id === compId);
    const currentPts = existing ? existing.points : '';
    const currentPlacement = currentPts !== '' ? (PTS_PLACEMENT[currentPts] || 'participant') : '';
    
    html += `
      <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--panel);border-radius:10px;border:1px solid var(--border)">
        ${avatarHtml(s.name, 32)}
        <div style="flex:1">
          <div style="font-weight:600;font-size:14px">${s.name}</div>
          <span class="dept-badge dept-${s.dept}" style="font-size:9px">${s.dept}</span>
        </div>
        <select id="grade-${s._id}" style="width:180px;padding:8px 12px;font-size:13px;font-weight:600" onchange="onPlacementSelect(this)">
          <option value="">‚Äî Select ‚Äî</option>
          <option value="1st" ${currentPlacement==='1st'?'selected':''}>ü•á 1st Place (25 pts)</option>
          <option value="2nd" ${currentPlacement==='2nd'?'selected':''}>ü•à 2nd Place (20 pts)</option>
          <option value="3rd" ${currentPlacement==='3rd'?'selected':''}>ü•â 3rd Place (15 pts)</option>
          <option value="participant" ${currentPlacement==='participant'?'selected':''}>‚ú¶ Participant (10 pts)</option>
        </select>
        ${existing ? '<span style="font-size:10px;color:var(--gold);font-weight:700">SCORED</span>' : ''}
      </div>`;
  });
  
  html += `</div>
    <div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="assignAllParticipant('${compId}')">Set All as Participant</button>
      <button class="btn btn-primary" onclick="saveAllGrades('${compId}')">‚ú¶ Save All Grades</button>
    </div>`;
  
  panel.innerHTML = html;
}

function onPlacementSelect(sel) {
  // Visual feedback
  sel.style.borderColor = sel.value ? 'var(--gold-d)' : 'var(--border2)';
}

function assignAllParticipant(compId) {
  const enrolledStudents = state.students.filter(s => 
    s.enrolledCompetitions && s.enrolledCompetitions.includes(compId)
  );
  enrolledStudents.forEach(s => {
    const sel = document.getElementById(`grade-${s._id}`);
    if (sel && !sel.value) sel.value = 'participant';
  });
}

async function saveAllGrades(compId) {
  const enrolledStudents = state.students.filter(s => 
    s.enrolledCompetitions && s.enrolledCompetitions.includes(compId)
  );
  
  let saved = 0;
  let errors = 0;
  
  for (const s of enrolledStudents) {
    const sel = document.getElementById(`grade-${s._id}`);
    if (!sel || !sel.value) continue;
    
    const points = PLACEMENT_PTS[sel.value];
    if (points === undefined) continue;
    
    try {
      const res = await fetch(`${API}/scores`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId: s._id, competitionId: compId, points })
      });
      if (!res.ok) throw new Error((await res.json()).error);
      const sc = await res.json();
      // Upsert in local state
      const idx = state.scores.findIndex(x => x.student?._id === s._id && x.competition?._id === compId);
      if (idx >= 0) state.scores[idx] = sc;
      else state.scores.unshift(sc);
      saved++;
    } catch(e) {
      errors++;
    }
  }
  
  updateBadges();
  renderScores();
  onGradeCompChange(); // refresh panel to show SCORED badges
  
  if (saved > 0) toast(`‚úÖ ${saved} grade${saved!==1?'s':''} saved!`);
  if (errors > 0) toast(`${errors} error${errors!==1?'s':''} occurred`, 'error');
}

// ‚îÄ‚îÄ SCORES TABLE ‚îÄ‚îÄ
function renderScores() {
  const tb     = document.getElementById('scores-tbody');
  const fComp  = document.getElementById('scores-filter-comp').value;
  const fDept  = document.getElementById('scores-filter-dept').value;
  let filtered = state.scores.filter(s => {
    if(fComp && s.competition?._id !== fComp) return false;
    if(fDept && s.student?.dept !== fDept)    return false;
    return true;
  });
  if(!filtered.length) {
    tb.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="empty-icon">üìù</div>No scores recorded yet</div></td></tr>`;
    return;
  }
  tb.innerHTML = filtered.map(s => {
    const barColor = s.competition?.category?.startsWith('ace') ? '#3b82f6' : '#ec4899';
    return `
    <tr>
      <td><div style="display:flex;align-items:center;gap:8px">${avatarHtml(s.student?.name||'?',28)}<span style="font-weight:600">${s.student?.name||'‚Äî'}</span></div></td>
      <td>${s.competition?.name||'‚Äî'}</td>
      <td><span class="cat-badge cat-${s.competition?.category||''}">${CAT_LABELS[s.competition?.category]||'‚Äî'}</span></td>
      <td>${placementLabel(s.points)}</td>
      <td>
        <span class="pts-badge">${s.points}</span>
        <div class="score-bar-wrap" style="max-width:80px"><div class="score-bar" style="width:${s.points/25*100}%;background:${barColor}"></div></div>
      </td>
      <td style="color:var(--muted);font-size:12px">${fmtDate(s.updatedAt||s.createdAt)}</td>
      <td><button class="btn btn-danger" onclick="deleteScore('${s._id}')">‚úï</button></td>
    </tr>`;
  }).join('');
}

async function deleteScore(id) {
  confirmModal('Delete this score entry?', async () => {
    await fetch(`${API}/scores/${id}`,{method:'DELETE'});
    state.scores = state.scores.filter(s=>s._id!==id);
    updateBadges(); renderScores();
    toast('Score deleted');
  });
}

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ
async function loadLeaderboard() {
  try {
    const data = await fetch(`${API}/leaderboard`).then(r=>r.json());

    // Overall
    const ob = document.getElementById('lb-overall');
    if(!data.overall.length) {
      ob.innerHTML = `<tr><td colspan="8"><div class="empty">No data yet</div></td></tr>`;
    } else {
      const maxTot = data.overall[0]?.total || 1;
      ob.innerHTML = data.overall.map((row,i) => {
        const rc = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-n';
        const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1;
        return `<tr>
          <td><span class="rank-num ${rc}">${medal}</span></td>
          <td><div style="display:flex;align-items:center;gap:8px">${avatarHtml(row.student.name)}<strong>${row.student.name}</strong></div></td>
          <td><span class="dept-badge dept-${row.student.dept}">${row.student.dept}</span></td>
          <td style="color:#93c5fd">${row.cats.ace1  !=null ? row.cats.ace1  : '<span style="color:var(--muted2)">‚Äî</span>'}</td>
          <td style="color:#67e8f9">${row.cats.ace2  !=null ? row.cats.ace2  : '<span style="color:var(--muted2)">‚Äî</span>'}</td>
          <td style="color:#f9a8d4">${row.cats.arena1!=null ? row.cats.arena1: '<span style="color:var(--muted2)">‚Äî</span>'}</td>
          <td style="color:#fdba74">${row.cats.arena2!=null ? row.cats.arena2: '<span style="color:var(--muted2)">‚Äî</span>'}</td>
          <td><span class="pts-badge" style="font-size:22px">${row.total}</span>
            <div class="score-bar-wrap" style="max-width:80px;margin-top:4px"><div class="score-bar" style="width:${Math.round(row.total/maxTot*100)}%;background:linear-gradient(to right,#a07520,var(--gold))"></div></div>
          </td>
        </tr>`;
      }).join('');
    }

    // Per category
    ['ace1','ace2','arena1','arena2'].forEach(cat => {
      const rows = data.catLeaders[cat] || [];
      const barColor = cat.startsWith('ace') ? '#3b82f6' : '#ec4899';
      const el = document.getElementById('lb-'+cat);
      if(!rows.length) {
        el.innerHTML = `<tr><td colspan="3"><div class="empty">No scores yet</div></td></tr>`;
        return;
      }
      const maxP = rows[0]?.points || 1;
      el.innerHTML = rows.map((r,i) => {
        const rc = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-n';
        const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1;
        return `<tr>
          <td><span class="rank-num ${rc}">${medal}</span></td>
          <td><div style="display:flex;align-items:center;gap:8px">${avatarHtml(r.name)}<span style="font-weight:600">${r.name}</span></div></td>
          <td><span class="pts-badge">${r.points}</span>
            <div class="score-bar-wrap" style="max-width:70px;margin-top:3px"><div class="score-bar" style="width:${Math.round(r.points/maxP*100)}%;background:${barColor}"></div></div>
          </td>
        </tr>`;
      }).join('');
    });
  } catch(e) { toast('Failed to load leaderboard','error'); }
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function miniLeaderHtml(leaders, barColor) {
  if(!leaders||!leaders.length) return `<div class="empty" style="padding:20px 0"><div class="empty-icon" style="font-size:24px">üìä</div>No scores yet</div>`;
  const maxP = leaders[0].points||1;
  return leaders.slice(0,3).map((r,i)=>{
    const rc = i===0?'rank-1':i===1?'rank-2':'rank-3';
    const medal = ['ü•á','ü•à','ü•â'][i];
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(37,47,74,0.4)">
      <span class="rank-num ${rc}" style="font-size:16px;width:24px;text-align:center">${medal}</span>
      ${avatarHtml(r.name)}
      <div style="flex:1">
        <div style="font-weight:600;font-size:13px">${r.name}</div>
        <div class="score-bar-wrap"><div class="score-bar" style="width:${Math.round(r.points/maxP*100)}%;background:${barColor}"></div></div>
      </div>
      <span class="pts-badge" style="font-size:16px">${r.points}</span>
    </div>`;
  }).join('');
}

async function logout() {
  await fetch('/auth/logout', { 
    method: 'POST',
    credentials: 'include'
  });
  window.location.href = '/';
}

async function loadDashboard() {
  try {
    const data = await fetch(`${API}/leaderboard`).then(r=>r.json());
    // Overall top 5
    const ob = document.getElementById('dash-overall');
    if(!data.overall.length) {
      ob.innerHTML = `<div class="empty"><div class="empty-icon">üèÜ</div>No scores yet</div>`;
    } else {
      const maxT = data.overall[0]?.total||1;
      ob.innerHTML = data.overall.slice(0,5).map((row,i)=>{
        const rc = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-n';
        const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1;
        return `<div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid rgba(37,47,74,0.4)">
          <span class="rank-num ${rc}" style="width:24px;text-align:center">${medal}</span>
          ${avatarHtml(row.student.name)}
          <div style="flex:1">
            <div style="font-weight:600;font-size:13px">${row.student.name}</div>
            <div style="font-size:11px;color:var(--muted)">${row.student.dept}</div>
            <div class="score-bar-wrap"><div class="score-bar" style="width:${Math.round(row.total/maxT*100)}%;background:linear-gradient(to right,#a07520,var(--gold))"></div></div>
          </div>
          <span class="pts-badge">${row.total}</span>
        </div>`;
      }).join('');
    }
    // Per category minis
    document.getElementById('dash-ace1').innerHTML   = miniLeaderHtml(data.catLeaders.ace1,   '#3b82f6');
    document.getElementById('dash-ace2').innerHTML   = miniLeaderHtml(data.catLeaders.ace2,   '#06b6d4');
    document.getElementById('dash-arena1').innerHTML = miniLeaderHtml(data.catLeaders.arena1, '#ec4899');
    document.getElementById('dash-arena2').innerHTML = miniLeaderHtml(data.catLeaders.arena2, '#f97316');
  } catch(e) {}

  // Recent scores
  const rb = document.getElementById('dash-recent');
  const recent = state.scores.slice(0,5);
  if(!recent.length) {
    rb.innerHTML = `<div class="empty"><div class="empty-icon">üìù</div>No scores yet</div>`;
  } else {
    rb.innerHTML = recent.map(s=>`
      <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(37,47,74,0.4)">
        ${avatarHtml(s.student?.name||'?',28)}
        <div style="flex:1">
          <div style="font-weight:600;font-size:13px">${s.student?.name||'‚Äî'}</div>
          <div style="font-size:11px;color:var(--muted)">${s.competition?.name||'‚Äî'}</div>
        </div>
        ${placementLabel(s.points)}
        <span class="pts-badge" style="font-size:18px">${s.points}</span>
      </div>`).join('');
  }
}

// ‚îÄ‚îÄ SET DEFAULT DATE ‚îÄ‚îÄ
document.getElementById('cp-date').value = new Date().toISOString().slice(0,10);

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadAll();
</script>
</body>
</html>
